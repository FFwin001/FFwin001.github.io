<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>01game分享奖金记录系统</title>
    <!-- 引入Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Toast通知库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <!-- 引入Emoji选择器 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/dist/index.min.css">
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/dist/index.min.js"></script>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc05;
            --light-gray: #f5f5f5;
            --dark-gray: #333;
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: white;
            --border-color: #ddd;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 登录页面样式 */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-container h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .login-btn:hover {
            background-color: #3367d6;
        }
        
        /* 主应用样式 */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .app-title {
            font-size: 24px;
            color: var(--primary-color);
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 15px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab:hover {
            background-color: #e1e1e1;
        }
        
        .tab.active {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--card-bg);
            margin-bottom: -1px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 15px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3367d6;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #2d9249;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d33426;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-gray);
        }
        
        .btn-warning:hover {
            background-color: #e6ac04;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .recent-records, .all-records, .recycle-bin {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 20px;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: var(--card-bg);
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .image-preview {
            max-width: 80px;
            max-height: 80px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            margin-top: 30px;
            animation: zoom 0.3s;
        }
        
        @keyframes zoom {
            from {transform: scale(0.5); opacity: 0;}
            to {transform: scale(1); opacity: 1;}
        }
        
        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .upload-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .upload-option {
            padding: 8px 15px;
            background-color: #e9e9e9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-option.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        #pasteArea {
            width: 100%;
            height: 150px;
            border: 2px dashed #ccc;
            text-align: center;
            padding: 20px;
            margin-top: 10px;
            display: none;
            background-color: #f9f9f9;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #666;
        }
        
        #pasteArea.active {
            border-color: var(--primary-color);
            background-color: #eef6ff;
        }
        
        .image-preview-container {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .image-preview-item {
            position: relative;
        }
        
        .image-preview-item img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .preview-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .stat-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
        }
        
        .filter-item label {
            margin-right: 8px;
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-btn:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #666;
        }
        
        .empty-state i {
            font-size: 50px;
            color: #ddd;
            margin-bottom: 15px;
            display: block;
        }
        
        /* 主题选择器 */
        .theme-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .theme-options {
            position: absolute;
            bottom: 60px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            display: none;
            width: 200px;
        }
        
        .theme-options.show {
            display: block;
        }
        
        .theme-option {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .theme-option:hover {
            background-color: #f5f5f5;
        }
        
        .theme-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid var(--border-color);
        }
        
        /* 封面设置 */
        .cover-settings {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 100;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            display: none;
            width: 300px;
        }
        
        .cover-settings.show {
            display: block;
        }
        
        .cover-preview {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        
        /* 批量操作 */
        .batch-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        /* 调整全选复选框样式 */
        .batch-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .batch-checkbox-label {
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        /* 聊天室样式 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            overflow: hidden;
            position: relative;
        }
        
        .chat-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-align: center;
            position: relative;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
            word-break: break-word;
        }
        
        .message-sender {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .message-time {
            font-size: 10px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }
        
        .message-actions {
            display: none;
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .message:hover .message-actions {
            display: flex;
            gap: 5px;
        }
        
        .message-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #666;
        }
        
        .message-action-btn:hover {
            color: var(--primary-color);
        }
        
        .sent {
            align-items: flex-end;
        }
        
        .sent .message-content {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0;
        }
        
        .received {
            align-items: flex-start;
        }
        
        .received .message-content {
            background-color: var(--light-gray);
            color: var(--text-color);
            border-bottom-left-radius: 0;
        }
        
        .chat-input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            resize: none;
            max-height: 100px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .chat-input:focus {
            border-color: var(--primary-color);
        }
        
        .send-btn {
            margin-left: 10px;
            padding: 0 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .send-btn:hover {
            background-color: #3367d6;
        }
        
        .emoji-btn {
            margin-right: 10px;
            padding: 0 15px;
            background-color: var(--light-gray);
            color: var(--text-color);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .emoji-btn:hover {
            background-color: #e1e1e1;
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 20px;
            z-index: 100;
            display: none;
        }
        
        .emoji-picker.show {
            display: block;
        }
        
        /* 图片消息样式 */
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .image-message .message-text {
            display: none;
        }
        
        /* 消息通知样式 */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* 粘贴区域样式 */
        .chat-paste-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            display: none;
        }
        
        .chat-paste-area.active {
            display: flex;
        }
        
        .chat-paste-area-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        /* 模态框点击空白关闭 */
        .modal {
            cursor: pointer;
        }
        
        .modal-content {
            cursor: default;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .app-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-info {
                margin-top: 15px;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .theme-selector {
                bottom: 10px;
                right: 10px;
            }
            
            .theme-options {
                width: 150px;
            }
            
            .chat-container {
                height: 400px;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
        
        /* 加载动画 */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 封面背景 */
        .cover-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            z-index: -1;
            opacity: 0.1;
        }
        
        /* 管理员操作按钮 */
        .admin-actions {
            position: absolute;
            right: 10px;
            top: 10px;
        }

        /* 所有照片预览模态框 - 改进后的样式 */
        .all-images-modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            overflow: auto;
        }

        .all-images-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 80px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .all-images-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.9);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1051;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .all-images-title {
            font-size: 20px;
            font-weight: bold;
        }

        .all-images-close {
            font-size: 30px;
            cursor: pointer;
            padding: 5px 15px;
        }

        .all-images-close:hover {
            color: var(--primary-color);
        }

        .image-thumbnail {
            margin: 10px;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s;
        }

        .image-thumbnail:hover {
            transform: scale(1.05);
        }

        .image-thumbnail img {
            width: 250px;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .image-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            font-size: 12px;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-info-btn {
            margin-top: 5px;
            padding: 3px 8px;
            font-size: 11px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        /* 用户管理面板 */
        .user-management {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }

        .user-management h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .user-list {
            margin-top: 20px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .user-info-small {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 250px;
        }

        .user-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 16px;
        }

        .user-permissions {
            flex: 2;
            min-width: 300px;
            margin-top: 10px;
        }

        .permission-section {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
        }

        .permission-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .permission-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .permission-checkbox {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .permission-checkbox input {
            margin-right: 5px;
            width: auto;
        }

        .close-user-management {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-user-management:hover {
            color: var(--danger-color);
        }

        /* 权限标签样式 */
        .permission-tag {
            display: inline-block;
            padding: 3px 8px;
            background-color: #e1f5fe;
            color: #0288d1;
            border-radius: 3px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- 封面背景 -->
    <div id="coverBackground" class="cover-background"></div>
    
    <!-- 登录页面 -->
    <div id="loginPage" class="login-container">
        <h1>欢迎访问01game分享奖金记录系统</h1>
        <form class="login-form" onsubmit="return false;">
            <div class="form-group">
                <label for="loginEmail">邮箱</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">密码</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="button" class="login-btn" onclick="login()">登录</button>
            <p style="margin-top: 20px;">没有账号？<a href="#" onclick="showRegister()">注册</a></p>
        </form>
    </div>
    
    <!-- 注册页面 -->
    <div id="registerPage" class="login-container" style="display: none;">
        <h1>注册新账号</h1>
        <form class="login-form" onsubmit="return false;">
            <div class="form-group">
                <label for="registerName">姓名</label>
                <input type="text" id="registerName" required>
            </div>
            <div class="form-group">
                <label for="registerEmail">邮箱</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">密码 (至少6位)</label>
                <input type="password" id="registerPassword" required minlength="6">
            </div>
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="register()">注册</button>
                <button type="button" class="btn btn-secondary" onclick="showLogin()">返回登录</button>
            </div>
        </form>
    </div>
    
    <!-- 主应用页面 -->
    <div id="appPage" style="display: none;">
        <div class="container">
            <div class="app-header">
                <h1 class="app-title">001game分享奖金记录系统</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">用户</span>
                    <button class="logout-btn" onclick="logout()">退出</button>
                    <button id="userManagementBtn" class="btn btn-warning" style="display: none; margin-left: 10px;" onclick="showUserManagement()">用户管理</button>
                </div>
            </div>
            
            <div class="tabs" id="mainTabs">
                <div class="tab active" onclick="openTab(event, 'addRecord')">新增记录</div>
                <div class="tab" onclick="openTab(event, 'viewRecords')">查看记录</div>
                <div class="tab" onclick="openTab(event, 'duplicateRecords')">重复记录</div>
                <div class="tab" onclick="openTab(event, 'recycleBin')">回收站</div>
                <div class="tab" onclick="openTab(event, 'statistics')">数据统计</div>
                <div class="tab" onclick="openTab(event, 'chatRoom')">群聊 <span id="unreadBadge" class="notification-badge" style="display: none;">0</span></div>
            </div>
            
            <!-- 新增记录标签页 -->
            <div id="addRecord" class="tab-content active">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="memberId">会员ID:</label>
                                <input type="text" id="memberId" required onchange="updateDateTime()">
                            </div>
                            
                            <div class="form-group">
                                <label for="operator">操作人姓名:</label>
                                <select id="operator" required>
                                    <option value="">请选择操作人</option>
                                    <option value="妥妥">妥妥</option>
                                    <option value="北慕">北慕</option>
                                    <option value="周宁">周宁</option>
                                    <option value="小梅">小梅</option>
                                    <option value="阿四明">阿四明</option>
                                    <option value="小柠">小柠</option>
                                    <option value="俊成">俊成</option>
                                    <option value="张美娇">张美娇</option>
                                    <option value="佳欣">佳欣</option>
                                    <option value="小晨">小晨</option>
                                    <option value="劳斯">劳斯</option>
                                    <option value="小琳">小琳</option>
                                    <option value="小清">小清</option>
                                    <option value="老K">老K</option>
                                    <option value="筱筱">筱筱</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="operationTime">操作时间:</label>
                                <input type="text" id="operationTime" readonly>
                            </div>
                        </div>
                        
                        <div class="form-col">
                            <div class="form-group">
                                <label for="shareDuration">分享时长(小时):</label>
                                <input type="number" id="shareDuration" min="0" step="1" onchange="calculateAmount()">
                            </div>
                            
                            <div class="form-group">
                                <label for="amount">派送金额(R$):</label>
                                <input type="text" id="amount" readonly value="0">
                            </div>
                            
                            <div class="form-group">
                                <label for="notes">备注:</label>
                                <textarea id="notes"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>分享照片:</label>
                        <div class="upload-options">
                            <div class="upload-option active" onclick="selectUploadOption('file')">上传文件</div>
                            <div class="upload-option" onclick="selectUploadOption('paste')">全局粘贴 (Ctrl+V)</div>
                        </div>
                        
                        <input type="file" id="imageUpload" accept="image/*" multiple style="display: block;">
                        <div id="pasteArea">按Ctrl+V粘贴图片</div>
                        
                        <div id="imagePreviewContainer" class="image-preview-container"></div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="saveRecord()">保存记录</button>
                        <button type="reset" class="btn btn-secondary">重置</button>
                    </div>
                </form>
                
                <div class="recent-records">
                    <h2 class="section-title">最近10条记录</h2>
                    <div class="table-responsive">
                        <table id="recentRecordsTable">
                            <thead>
                                <tr>
                                    <th>会员ID</th>
                                    <th>操作人</th>
                                    <th>操作时间</th>
                                    <th>分享时长</th>
                                    <th>派送金额</th>
                                    <th>图片</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="recentRecordsBody">
                                <!-- 最近记录将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 查看记录标签页 -->
            <div id="viewRecords" class="tab-content">
                <div class="batch-actions">
                    <label class="batch-checkbox-label">
                        <input type="checkbox" id="selectAll" class="batch-checkbox" onchange="toggleSelectAll()">
                        <span>全选</span>
                    </label>
                    <button class="btn btn-danger" onclick="batchDeleteRecords()">批量删除</button>
                    <button class="btn btn-secondary" onclick="exportToCSV()">导出CSV</button>
                    <button class="btn btn-primary" onclick="previewAllImages()">一键预览所有照片</button>
                </div>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" class="search-input" placeholder="搜索会员ID、操作人或备注">
                    <button class="btn btn-primary" onclick="searchRecords()">搜索</button>
                    <button class="btn btn-secondary" onclick="resetSearch()">重置</button>
                </div>
                
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="dateFrom">从:</label>
                        <input type="date" id="dateFrom">
                    </div>
                    <div class="filter-item">
                        <label for="dateTo">到:</label>
                        <input type="date" id="dateTo">
                    </div>
                    <div class="filter-item">
                        <label for="operatorFilter">操作人:</label>
                        <select id="operatorFilter">
                            <option value="">全部</option>
                            <option value="妥妥">妥妥</option>
                                    <option value="北慕">北慕</option>
                                    <option value="周宁">周宁</option>
                                    <option value="小梅">小梅</option>
                                    <option value="阿四明">阿四明</option>
                                    <option value="小柠">小柠</option>
                                    <option value="俊成">俊成</option>
                                    <option value="张美娇">张美娇</option>
                                    <option value="佳欣">佳欣</option>
                                    <option value="小晨">小晨</option>
                                    <option value="劳斯">劳斯</option>
                                    <option value="小琳">小琳</option>
                                    <option value="小清">小清</option>
                                    <option value="老K">老K</option>
                                    <option value="筱筱">筱筱</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="applyFilters()">应用筛选</button>
                </div>
                
                <div class="all-records">
                    <div class="table-responsive">
                        <table id="allRecordsTable">
                            <thead>
                                <tr>
                                    <th width="40px"></th>
                                    <th>会员ID</th>
                                    <th>操作人</th>
                                    <th>操作时间</th>
                                    <th>分享时长</th>
                                    <th>派送金额</th>
                                    <th>备注</th>
                                    <th>图片</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="allRecordsBody">
                                <!-- 所有记录将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination" id="pagination">
                        <!-- 分页按钮将在这里动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 重复记录标签页 -->
            <div id="duplicateRecords" class="tab-content">
                <h2 class="section-title">重复会员ID记录</h2>
                <div class="table-responsive">
                    <table id="duplicateIdTable">
                        <thead>
                            <tr>
                                <th>会员ID</th>
                                <th>记录数量</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="duplicateIdBody">
                            <!-- 重复ID记录将在这里动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">重复图片记录</h2>
                <div class="table-responsive">
                    <table id="duplicateImageTable">
                        <thead>
                            <tr>
                                <th>图片</th>
                                <th>记录数量</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="duplicateImageBody">
                            <!-- 重复图片记录将在这里动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 回收站标签页 -->
            <div id="recycleBin" class="tab-content">
                <div class="batch-actions">
                    <label class="batch-checkbox-label">
                        <input type="checkbox" id="selectAllRecycle" class="batch-checkbox" onchange="toggleSelectAllRecycle()">
                        <span>全选</span>
                    </label>
                    <button class="btn btn-secondary" onclick="batchRestoreRecords()">批量恢复</button>
                    <button class="btn btn-danger" onclick="batchPermanentDeleteRecords()">批量永久删除</button>
                </div>
                
                <div class="recycle-bin">
                    <h2 class="section-title">回收站</h2>
                    <p>已删除的记录将在此保留30天</p>
                    
                    <div class="table-responsive">
                        <table id="recycleBinTable">
                            <thead>
                                <tr>
                                    <th width="40px"></th>
                                    <th>会员ID</th>
                                    <th>操作人</th>
                                    <th>操作时间</th>
                                    <th>删除时间</th>
                                    <th>分享时长</th>
                                    <th>派送金额</th>
                                    <th>图片</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="recycleBinBody">
                                <!-- 回收站记录将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination" id="recyclePagination">
                        <!-- 分页按钮将在这里动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 数据统计标签页 -->
            <div id="statistics" class="tab-content">
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-title">总记录数</div>
                        <div class="stat-value" id="totalRecords">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">总派送金额</div>
                        <div class="stat-value" id="totalAmount">R$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">总分享时长</div>
                        <div class="stat-value" id="totalDuration">0小时</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">今日新增记录</div>
                        <div class="stat-value" id="todayRecords">0</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>每日记录数量</h3>
                    <canvas id="recordsChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>操作人记录分布</h3>
                    <canvas id="operatorChart"></canvas>
                </div>
            </div>
            
            <!-- 群聊标签页 -->
            <div id="chatRoom" class="tab-content">
                <div class="chat-container">
                    <div class="chat-header">
                        团队群聊
                        <span id="unreadBadge" class="notification-badge" style="display: none;">0</span>
                        <div class="admin-actions" id="adminActions" style="display: none;">
                            <button class="btn btn-danger" onclick="clearAllMessages()">清空聊天记录</button>
                        </div>
                    </div>
                    <div class="chat-paste-area" id="chatPasteArea">
                        <div class="chat-paste-area-content">
                            <p>松开鼠标粘贴图片</p>
                            <p><small>支持直接粘贴截图或图片文件</small></p>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- 聊天消息将在这里动态生成 -->
                    </div>
                    <div class="chat-input-container">
                        <button class="emoji-btn" id="emojiBtn">😊</button>
                        <textarea class="chat-input" id="chatInput" placeholder="输入消息..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">发送</button>
                    </div>
                </div>
                <emoji-picker class="emoji-picker" id="emojiPicker"></emoji-picker>
            </div>
        </div>
    </div>
    
    <!-- 图片预览模态框 -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close" onclick="event.stopPropagation(); closeModal()">&times;</span>
        <img class="modal-content" id="modalImage" onclick="event.stopPropagation()">
    </div>
    
    <!-- 所有照片预览模态框 - 改进后的版本 -->
    <div id="allImagesModal" class="all-images-modal">
        <div class="all-images-header">
            <div class="all-images-title">所有照片预览 (共<span id="totalImagesCount">0</span>张)</div>
            <div class="all-images-close" onclick="closeAllImagesModal()">&times;</div>
        </div>
        <div class="all-images-content" id="allImagesContent">
            <!-- 所有照片将在这里动态生成 -->
        </div>
    </div>
    
    <!-- 编辑记录模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 600px; background: var(--card-bg); padding: 20px; margin-top: 50px;">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>编辑记录</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editMemberId">会员ID:</label>
                            <input type="text" id="editMemberId" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editOperator">操作人姓名:</label>
                            <select id="editOperator" required>
                                <option value="妥妥">妥妥</option>
                                    <option value="北慕">北慕</option>
                                    <option value="周宁">周宁</option>
                                    <option value="小梅">小梅</option>
                                    <option value="阿四明">阿四明</option>
                                    <option value="小柠">小柠</option>
                                    <option value="俊成">俊成</option>
                                    <option value="张美娇">张美娇</option>
                                    <option value="佳欣">佳欣</option>
                                    <option value="小晨">小晨</option>
                                    <option value="劳斯">劳斯</option>
                                    <option value="小琳">小琳</option>
                                    <option value="小清">小清</option>
                                    <option value="老K">老K</option>
                                    <option value="筱筱">筱筱</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editShareDuration">分享时长(小时):</label>
                            <input type="number" id="editShareDuration" min="0" step="1" onchange="calculateEditAmount()">
                        </div>
                        
                        <div class="form-group">
                            <label for="editAmount">派送金额(R$):</label>
                            <input type="text" id="editAmount" readonly value="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editNotes">备注:</label>
                    <textarea id="editNotes"></textarea>
                </div>
                
                <div class="form-group">
                    <label>分享照片:</label>
                    <div id="editImagePreviewContainer" class="image-preview-container"></div>
                    <input type="file" id="editImageUpload" accept="image/*" multiple style="margin-top: 10px;">
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" onclick="updateRecord()">保存更改</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 用户管理面板 - 改进后的版本 -->
    <div id="userManagement" class="user-management">
        <div class="close-user-management" onclick="closeUserManagement()">&times;</div>
        <h2>用户管理</h2>
        <div class="user-list" id="userList">
            <!-- 用户列表将在这里动态生成 -->
        </div>
    </div>
    
    <!-- 主题选择器 -->
    <div class="theme-selector">
        <div class="theme-btn" onclick="toggleThemeOptions()">🎨</div>
        <div class="theme-options" id="themeOptions">
            <div class="theme-option" onclick="changeTheme('default')">
                <div class="theme-color" style="background: #4285f4;"></div>
                <span>默认主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('dark')">
                <div class="theme-color" style="background: #333;"></div>
                <span>暗黑主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('light')">
                <div class="theme-color" style="background: #f5f5f5;"></div>
                <span>明亮主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('green')">
                <div class="theme-color" style="background: #34a853;"></div>
                <span>绿色主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('blue')">
                <div class="theme-color" style="background: #1a73e8;"></div>
                <span>蓝色主题</span>
            </div>
        </div>
    </div>
    
    <!-- 封面设置 -->
    <div class="theme-selector" style="bottom: 80px;">
        <div class="theme-btn" onclick="toggleCoverSettings()">🖼️</div>
        <div class="cover-settings" id="coverSettings">
            <h3>封面设置</h3>
            <img id="coverPreview" class="cover-preview" src="" alt="封面预览">
            <input type="file" id="coverUpload" accept="image/*" style="margin-bottom: 10px;">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="uploadCover()">上传封面</button>
                <button class="btn btn-danger" onclick="removeCover()">移除封面</button>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyA5QkkltpVzOVH_rToj2qctTRMO4vg7o8c",
  authDomain: "project-7578283746996387970.firebaseapp.com",
  databaseURL: "https://project-7578283746996387970-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "project-7578283746996387970",
  storageBucket: "project-7578283746996387970.firebasestorage.app",
  messagingSenderId: "223990727962",
  appId: "1:223990727962:web:efb5e3a0a7e18acc8798a3",
};
        
        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // 全局变量
        let currentUser = null;
        let records = [];
        let deletedRecords = [];
        let currentImages = [];
        let editImages = [];
        let currentUploadOption = 'file';
        let currentPage = 1;
        const recordsPerPage = 10;
        let currentRecyclePage = 1;
        const recyclePerPage = 10;
        let recordsChart = null;
        let operatorChart = null;
        let selectedRecords = new Set();
        let selectedDeletedRecords = new Set();
        let recordsRef = null;
        let deletedRecordsRef = null;
        let messagesRef = null;
        let unreadMessages = 0;
        let isChatTabActive = true;
        let lastSeenMessageTime = 0;
        const adminEmails = ["01gamebeimu@gmail.com"]; // 替换为实际的管理员邮箱
        let allImages = []; // 存储所有图片数据
        let users = []; // 存储所有用户数据
        let userPermissions = {}; // 存储用户权限
        
        // 显示Toast通知
        function showToast(message, type = 'success') {
            const background = type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3';
            
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: background,
                stopOnFocus: true
            }).showToast();
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 监听粘贴事件
            document.addEventListener('paste', function(e) {
                if (currentUploadOption === 'paste') {
                    handlePaste(e);
                }
            });
            
            // 监听文件上传
            document.getElementById('imageUpload').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    previewImages(e.target.files);
                }
            });
            
            // 监听编辑图片上传
            document.getElementById('editImageUpload').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    previewEditImages(e.target.files);
                }
            });
            
            // 监听封面图片上传
            document.getElementById('coverUpload').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    previewCover(e.target.files[0]);
                }
            });
            
            // 监听键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's' && document.getElementById('addRecord').classList.contains('active')) {
                    e.preventDefault();
                    saveRecord();
                }
                
                // ESC键关闭模态框
                if (e.key === 'Escape') {
                    if (document.getElementById('imageModal').style.display === 'block') {
                        closeModal();
                    }
                    if (document.getElementById('editModal').style.display === 'block') {
                        closeEditModal();
                    }
                    if (document.getElementById('emojiPicker').classList.contains('show')) {
                        toggleEmojiPicker();
                    }
                    if (document.getElementById('allImagesModal').style.display === 'block') {
                        closeAllImagesModal();
                    }
                    if (document.getElementById('userManagement').style.display === 'block') {
                        closeUserManagement();
                    }
                }
                
                // 回车发送消息
                if (e.key === 'Enter' && !e.shiftKey && document.getElementById('chatRoom').classList.contains('active')) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 监听认证状态变化
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showAppPage();
                    setupRealtimeListeners();
                    updateUserInfo();
                    loadCover();
                    loadTheme();
                    loadUserPermissions();
                    
                    // 检查是否是管理员
                    if (adminEmails.includes(user.email)) {
                        document.getElementById('adminActions').style.display = 'block';
                        document.getElementById('userManagementBtn').style.display = 'block';
                    }
                } else {
                    showLoginPage();
                    if (recordsRef) recordsRef.off();
                    if (deletedRecordsRef) deletedRecordsRef.off();
                    if (messagesRef) messagesRef.off();
                }
            });
            
            // 初始化日期筛选器为最近30天
            const dateTo = new Date();
            const dateFrom = new Date();
            dateFrom.setDate(dateFrom.getDate() - 30);
            
            document.getElementById('dateFrom').valueAsDate = dateFrom;
            document.getElementById('dateTo').valueAsDate = dateTo;
            
            // 初始化聊天输入框自动调整高度
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // 初始化表情选择器
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.addEventListener('emoji-click', event => {
                chatInput.value += event.detail.unicode;
                chatInput.focus();
            });
            
            // 表情按钮点击事件
            document.getElementById('emojiBtn').addEventListener('click', toggleEmojiPicker);
            
            // 监听聊天输入框粘贴事件
            chatInput.addEventListener('paste', handleChatPaste);
            
            // 监听聊天区域拖放事件
            const chatContainer = document.querySelector('.chat-container');
            chatContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                document.getElementById('chatPasteArea').classList.add('active');
            });
            
            chatContainer.addEventListener('dragleave', function() {
                document.getElementById('chatPasteArea').classList.remove('active');
            });
            
            chatContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                document.getElementById('chatPasteArea').classList.remove('active');
                handleChatPaste(e);
            });
            
            // 监听标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.textContent.trim().includes('群聊')) {
                        isChatTabActive = true;
                        resetUnreadCount();
                    } else {
                        isChatTabActive = false;
                    }
                });
            });
        });
        
        // 设置实时监听器
        function setupRealtimeListeners() {
            // 监听记录变化
            recordsRef = database.ref('records').orderByChild('createdAt');
            recordsRef.on('value', snapshot => {
                records = [];
                allImages = []; // 清空所有图片数据
                snapshot.forEach(childSnapshot => {
                    const record = childSnapshot.val();
                    record.id = childSnapshot.key;
                    records.unshift(record); // 添加到数组开头
                    
                    // 收集所有图片
                    if (record.image) {
                        if (Array.isArray(record.image)) {
                            record.image.forEach(img => {
                                allImages.push({
                                    image: img,
                                    record: record
                                });
                            });
                        } else {
                            allImages.push({
                                image: record.image,
                                record: record
                            });
                        }
                    }
                });
                
                loadRecentRecords();
                loadAllRecords(currentPage);
                updateStatistics();
                loadDuplicateRecords();
                
                // 如果当前在统计页面，更新图表
                if (document.getElementById('statistics').classList.contains('active')) {
                    updateCharts();
                }
            });
            
            // 监听已删除记录变化
            deletedRecordsRef = database.ref('deletedRecords').orderByChild('deletedAt');
            deletedRecordsRef.on('value', snapshot => {
                deletedRecords = [];
                snapshot.forEach(childSnapshot => {
                    const record = childSnapshot.val();
                    record.id = childSnapshot.key;
                    deletedRecords.unshift(record); // 添加到数组开头
                });
                
                loadRecycleBin(currentRecyclePage);
            });
            
            // 监听聊天消息变化
            messagesRef = database.ref('messages').orderByChild('timestamp').limitToLast(100);
            messagesRef.on('value', snapshot => {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                snapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    message.id = childSnapshot.key;
                    renderMessage(message);
                });
                
                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // 如果不是当前用户发送的消息且聊天标签页不是活动状态，增加未读计数
                if (!isChatTabActive && snapshot.val()) {
                    const lastMessage = Object.values(snapshot.val()).pop();
                    if (lastMessage.sender !== currentUser.uid && lastMessage.timestamp > lastSeenMessageTime) {
                        incrementUnreadCount();
                    }
                }
            });
            
            // 监听用户列表变化
            database.ref('users').on('value', snapshot => {
                users = [];
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    user.id = childSnapshot.key;
                    users.push(user);
                });
                
                // 如果用户管理面板打开，更新用户列表
                if (document.getElementById('userManagement').style.display === 'block') {
                    renderUserList();
                }
            });
            
            // 监听用户权限变化
            database.ref('userPermissions').on('value', snapshot => {
                userPermissions = snapshot.val() || {};
                
                // 更新当前用户的标签页访问权限
                if (currentUser) {
                    updateTabAccess();
                }
            });
        }
        
        // 更新标签页访问权限
        function updateTabAccess() {
            if (!currentUser) return;
            
            const tabs = document.querySelectorAll('.tab');
            const currentUserId = currentUser.uid;
            const permissions = userPermissions[currentUserId] || {};
            
            // 默认所有标签页都可见
            tabs.forEach(tab => {
                tab.style.display = '';
            });
            
            // 如果有权限设置，则根据设置隐藏标签页
            if (permissions.disabledTabs) {
                permissions.disabledTabs.forEach(tabId => {
                    const tab = document.querySelector(`.tab[onclick*="${tabId}"]`);
                    if (tab) {
                        tab.style.display = 'none';
                    }
                });
            }
            
            // 如果当前活动标签页被隐藏，切换到第一个可见的标签页
            const activeTabContent = document.querySelector('.tab-content.active');
            if (activeTabContent && activeTabContent.style.display === 'none') {
                const firstVisibleTab = document.querySelector('.tab:not([style*="display: none"])');
                if (firstVisibleTab) {
                    firstVisibleTab.click();
                }
            }
        }
        
        // 加载用户权限
        function loadUserPermissions() {
            if (!currentUser) return;
            
            database.ref('userPermissions/' + currentUser.uid).once('value')
                .then(snapshot => {
                    const permissions = snapshot.val() || {};
                    updateTabAccess();
                })
                .catch(error => {
                    console.error('加载用户权限失败:', error);
                });
        }
        
        // 显示用户管理面板
        function showUserManagement() {
            if (!adminEmails.includes(currentUser.email)) {
                showToast('只有管理员可以访问用户管理', 'error');
                return;
            }
            
            document.getElementById('userManagement').style.display = 'block';
            renderUserList();
        }
        
        // 关闭用户管理面板
        function closeUserManagement() {
            document.getElementById('userManagement').style.display = 'none';
        }
        
        // 渲染用户列表
        function renderUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            if (users.length === 0) {
                userList.innerHTML = '<p>暂无用户</p>';
                return;
            }
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info-small';
                userInfo.innerHTML = `
                    <div class="user-avatar-small">${user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U'}</div>
                    <div>
                        <div><strong>${user.displayName || '未命名用户'}</strong></div>
                        <div style="font-size: 12px; color: #666;">${user.email}</div>
                        <div style="font-size: 12px; color: #888;">ID: ${user.id}</div>
                    </div>
                `;
                
                const userPermissionsDiv = document.createElement('div');
                userPermissionsDiv.className = 'user-permissions';
                
                // 创建权限部分
                const tabPermissionsSection = createPermissionSection('标签页权限', [
                    { id: 'addRecord', name: '新增记录' },
                    { id: 'viewRecords', name: '查看记录' },
                    { id: 'duplicateRecords', name: '重复记录' },
                    { id: 'recycleBin', name: '回收站' },
                    { id: 'statistics', name: '数据统计' },
                    { id: 'chatRoom', name: '群聊' }
                ], user.id, 'disabledTabs');
                
                const recordPermissionsSection = createPermissionSection('记录操作权限', [
                    { id: 'createRecord', name: '创建记录' },
                    { id: 'editRecord', name: '编辑记录' },
                    { id: 'deleteRecord', name: '删除记录' },
                    { id: 'restoreRecord', name: '恢复记录' },
                    { id: 'viewAllImages', name: '查看所有图片' }
                ], user.id, 'disabledRecordActions');
                
                const chatPermissionsSection = createPermissionSection('聊天权限', [
                    { id: 'sendMessage', name: '发送消息' },
                    { id: 'sendImage', name: '发送图片' },
                    { id: 'deleteMessage', name: '删除消息' }
                ], user.id, 'disabledChatActions');
                
                userPermissionsDiv.appendChild(tabPermissionsSection);
                userPermissionsDiv.appendChild(recordPermissionsSection);
                userPermissionsDiv.appendChild(chatPermissionsSection);
                
                userItem.appendChild(userInfo);
                userItem.appendChild(userPermissionsDiv);
                userList.appendChild(userItem);
            });
        }
        
        // 创建权限部分
        function createPermissionSection(title, permissions, userId, permissionKey) {
            const section = document.createElement('div');
            section.className = 'permission-section';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'permission-section-title';
            titleDiv.textContent = title;
            
            const checkboxesDiv = document.createElement('div');
            checkboxesDiv.className = 'permission-checkboxes';
            
            permissions.forEach(permission => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'permission-checkbox';
                
                const checkboxId = `permission-${userId}-${permission.id}`;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = checkboxId;
                checkbox.checked = true;
                
                // 检查用户是否有禁用该权限
                if (userPermissions[userId] && userPermissions[userId][permissionKey] && 
                    userPermissions[userId][permissionKey].includes(permission.id)) {
                    checkbox.checked = false;
                }
                
                checkbox.addEventListener('change', function() {
                    updateUserPermission(userId, permissionKey, permission.id, this.checked);
                });
                
                const label = document.createElement('label');
                label.htmlFor = checkboxId;
                label.textContent = permission.name;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxesDiv.appendChild(checkboxDiv);
            });
            
            section.appendChild(titleDiv);
            section.appendChild(checkboxesDiv);
            return section;
        }
        
        // 更新用户权限
        function updateUserPermission(userId, permissionKey, permissionId, enabled) {
            const userPermissionRef = database.ref('userPermissions/' + userId);
            
            userPermissionRef.once('value')
                .then(snapshot => {
                    const permissions = snapshot.val() || {};
                    
                    if (!permissions[permissionKey]) {
                        permissions[permissionKey] = [];
                    }
                    
                    if (enabled) {
                        // 从禁用列表中移除
                        permissions[permissionKey] = permissions[permissionKey].filter(id => id !== permissionId);
                    } else {
                        // 添加到禁用列表
                        if (!permissions[permissionKey].includes(permissionId)) {
                            permissions[permissionKey].push(permissionId);
                        }
                    }
                    
                    return userPermissionRef.set(permissions);
                })
                .then(() => {
                    showToast('权限已更新');
                })
                .catch(error => {
                    showToast('更新权限失败: ' + error.message, 'error');
                });
        }
        
        // 预览所有图片 - 改进后的版本
        function previewAllImages() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('viewAllImages')) {
                showToast('您没有权限查看所有图片', 'error');
                return;
            }
            
            if (allImages.length === 0) {
                showToast('没有找到任何图片', 'error');
                return;
            }
            
            const allImagesContent = document.getElementById('allImagesContent');
            allImagesContent.innerHTML = '';
            
            // 更新总图片数
            document.getElementById('totalImagesCount').textContent = allImages.length;
            
            allImages.forEach((imgData, index) => {
                const imageThumbnail = document.createElement('div');
                imageThumbnail.className = 'image-thumbnail';
                imageThumbnail.innerHTML = `
                    <img src="${imgData.image}" onclick="openImageModal('${imgData.image}')">
                    <div class="image-info">
                        <div>会员ID: ${imgData.record.memberId}</div>
                        <div>操作人: ${imgData.record.operator}</div>
                        <div>时间: ${imgData.record.operationTime}</div>
                        <button class="image-info-btn" onclick="event.stopPropagation(); viewRecord('${imgData.record.id}')">查看记录</button>
                    </div>
                `;
                allImagesContent.appendChild(imageThumbnail);
            });
            
            document.getElementById('allImagesModal').style.display = 'block';
        }
        
        // 关闭所有图片预览
        function closeAllImagesModal() {
            document.getElementById('allImagesModal').style.display = 'none';
        }
        
        // 查看记录
        function viewRecord(id) {
            // 关闭所有图片预览
            closeAllImagesModal();
            
            // 打开查看记录标签页
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelector('.tab-content.active').classList.remove('active');
            
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('viewRecords').classList.add('active');
            
            // 搜索该记录
            const record = records.find(r => r.id === id);
            if (record) {
                document.getElementById('searchInput').value = record.memberId;
                searchRecords();
                
                // 滚动到该记录
                setTimeout(() => {
                    const row = document.querySelector(`tr[data-record-id="${id}"]`);
                    if (row) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.style.backgroundColor = '#fff9c4';
                        setTimeout(() => {
                            row.style.backgroundColor = '';
                        }, 2000);
                    }
                }, 500);
            }
        }
        
        // 加载重复记录
        function loadDuplicateRecords() {
            // 按会员ID分组
            const idGroups = {};
            records.forEach(record => {
                if (!idGroups[record.memberId]) {
                    idGroups[record.memberId] = [];
                }
                idGroups[record.memberId].push(record);
            });
            
            // 过滤出重复ID
            const duplicateIds = Object.keys(idGroups).filter(id => idGroups[id].length > 1);
            
            // 渲染重复ID表格
            const duplicateIdBody = document.getElementById('duplicateIdBody');
            duplicateIdBody.innerHTML = '';
            
            if (duplicateIds.length === 0) {
                duplicateIdBody.innerHTML = '<tr><td colspan="3" class="empty-state"><i>没有重复会员ID记录</i></td></tr>';
            } else {
                duplicateIds.forEach(id => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${id}</td>
                        <td>${idGroups[id].length}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewDuplicateRecords('${id}')">查看记录</button>
                        </td>
                    `;
                    duplicateIdBody.appendChild(row);
                });
            }
            
            // 按图片分组
            const imageGroups = {};
            records.forEach(record => {
                if (record.image) {
                    const images = Array.isArray(record.image) ? record.image : [record.image];
                    images.forEach(img => {
                        if (!imageGroups[img]) {
                            imageGroups[img] = [];
                        }
                        imageGroups[img].push(record);
                    });
                }
            });
            
            // 过滤出重复图片
            const duplicateImages = Object.keys(imageGroups).filter(img => imageGroups[img].length > 1);
            
            // 渲染重复图片表格
            const duplicateImageBody = document.getElementById('duplicateImageBody');
            duplicateImageBody.innerHTML = '';
            
            if (duplicateImages.length === 0) {
                duplicateImageBody.innerHTML = '<tr><td colspan="3" class="empty-state"><i>没有重复图片记录</i></td></tr>';
            } else {
                duplicateImages.forEach(img => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${img}" class="image-preview" onclick="openImageModal('${img}')"></td>
                        <td>${imageGroups[img].length}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewDuplicateImageRecords('${img}')">查看记录</button>
                        </td>
                    `;
                    duplicateImageBody.appendChild(row);
                });
            }
        }
        
        // 查看重复ID记录
        function viewDuplicateRecords(memberId) {
            const duplicateRecords = records.filter(record => record.memberId === memberId);
            
            // 打开查看记录标签页
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelector('.tab-content.active').classList.remove('active');
            
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('viewRecords').classList.add('active');
            
            // 搜索该会员ID
            document.getElementById('searchInput').value = memberId;
            searchRecords();
            
            showToast(`已显示会员ID为 ${memberId} 的所有记录`);
        }
        
        // 查看重复图片记录
        function viewDuplicateImageRecords(image) {
            const duplicateRecords = records.filter(record => {
                if (!record.image) return false;
                if (Array.isArray(record.image)) {
                    return record.image.includes(image);
                } else {
                    return record.image === image;
                }
            });
            
            // 打开查看记录标签页
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelector('.tab-content.active').classList.remove('active');
            
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('viewRecords').classList.add('active');
            
            // 显示包含该图片的所有记录
            displaySearchResults(duplicateRecords);
            
            showToast(`已显示包含该图片的所有记录`);
        }
        
        // 显示登录页面
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('appPage').style.display = 'none';
        }
        
        // 显示注册页面
        function showRegister() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'block';
        }
        
        // 返回登录页面
        function showLogin() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('registerPage').style.display = 'none';
        }
        
        // 显示主应用页面
        function showAppPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('appPage').style.display = 'block';
            updateDateTime();
        }
        
        // 登录
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // 保存用户信息
                    const user = userCredential.user;
                    return database.ref('users/' + user.uid).set({
                        email: user.email,
                        displayName: user.displayName || '',
                        lastLogin: firebase.database.ServerValue.TIMESTAMP
                    });
                })
                .then(() => {
                    showToast('登录成功');
                })
                .catch(error => {
                    showToast('登录失败: ' + error.message, 'error');
                });
        }
        
        // 注册
        function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (name.length < 2) {
                showToast('请输入有效的姓名', 'error');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // 保存用户额外信息
                    const user = userCredential.user;
                    return Promise.all([
                        user.updateProfile({
                            displayName: name
                        }),
                        database.ref('users/' + user.uid).set({
                            email: user.email,
                            displayName: name,
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        })
                    ]);
                })
                .then(() => {
                    showToast('注册成功！');
                    showLogin();
                })
                .catch(error => {
                    showToast('注册失败: ' + error.message, 'error');
                });
        }
        
        // 登出
        function logout() {
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    records = [];
                    deletedRecords = [];
                    showToast('已成功登出');
                })
                .catch(error => {
                    showToast('登出失败: ' + error.message, 'error');
                });
        }
        
        // 更新用户信息显示
        function updateUserInfo() {
            if (currentUser) {
                const displayName = currentUser.displayName || '用户';
                document.getElementById('userName').textContent = displayName;
                document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
            }
        }
        
        // 切换标签页
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            // 如果切换到统计标签页，更新图表
            if (tabName === 'statistics') {
                updateCharts();
            }
            
            // 重置批量选择
            if (tabName === 'viewRecords' || tabName === 'recycleBin') {
                resetBatchSelection();
            }
            
            // 如果切换到聊天标签页，滚动到底部
            if (tabName === 'chatRoom') {
                setTimeout(() => {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
            
            // 隐藏表情选择器
            document.getElementById('emojiPicker').classList.remove('show');
        }
        
        // 更新操作时间
        function updateDateTime() {
            const now = new Date();
            const formattedDateTime = formatDateTime(now);
            document.getElementById('operationTime').value = formattedDateTime;
        }
        
        // 格式化日期时间
        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
        }
        
        // 计算派送金额
        function calculateAmount() {
            const duration = parseInt(document.getElementById('shareDuration').value) || 0;
            let amount = calculateAmountFromDuration(duration);
            document.getElementById('amount').value = amount.toFixed(2);
        }
        
        // 计算编辑表单的派送金额
        function calculateEditAmount() {
            const duration = parseInt(document.getElementById('editShareDuration').value) || 0;
            let amount = calculateAmountFromDuration(duration);
            document.getElementById('editAmount').value = amount.toFixed(2);
        }
        
        // 根据时长计算金额
        function calculateAmountFromDuration(duration) {
            if (duration = 24) {
                return 5;
               } else if (duration = 21) {
                return 5;
               } else if (duration = 18) {
                return 5;
              } else if (duration = 15) {
                return 5;
            } else if (duration = 12) {
                return 5;
            } else if (duration = 9) {
                return 5;
            } else if (duration = 6) {
                return 5;
            } else if (duration = 3) {
                return 5;
            }
            return 0;
        }
        
        // 选择上传方式
        function selectUploadOption(option) {
            currentUploadOption = option;
            const options = document.querySelectorAll('.upload-option');
            options.forEach(opt => opt.classList.remove('active'));
            
            if (option === 'file') {
                document.getElementById('imageUpload').style.display = 'block';
                document.getElementById('pasteArea').style.display = 'none';
                document.querySelector('.upload-options div:first-child').classList.add('active');
            } else {
                document.getElementById('imageUpload').style.display = 'none';
                document.getElementById('pasteArea').style.display = 'flex';
                document.querySelector('.upload-options div:last-child').classList.add('active');
            }
        }
        
        // 处理粘贴图片
        function handlePaste(e) {
            const pasteArea = document.getElementById('pasteArea');
            pasteArea.classList.add('active');
            
            const items = (e.clipboardData || window.clipboardData).items;
            let foundImage = false;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    previewImages([blob]);
                    foundImage = true;
                    break;
                }
            }
            
            if (!foundImage) {
                showToast('剪贴板中没有找到图片', 'error');
            }
            
            setTimeout(() => {
                pasteArea.classList.remove('active');
            }, 1000);
        }
        
        // 处理聊天粘贴图片
        function handleChatPaste(e) {
            const items = (e.clipboardData || e.dataTransfer || {}).items;
            if (!items) return;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    uploadChatImage(blob);
                    break;
                }
            }
        }
        
        // 上传聊天图片
        function uploadChatImage(blob) {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledChatActions && permissions.disabledChatActions.includes('sendImage')) {
                showToast('您没有权限发送图片', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const newMessageRef = database.ref('messages').push();
                newMessageRef.set({
                    id: newMessageRef.key,
                    image: e.target.result,
                    sender: currentUser.uid,
                    senderName: currentUser.displayName || '未知用户',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    deleted: false
                })
                .then(() => {
                    // 滚动到底部
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(error => {
                    showToast('发送图片失败: ' + error.message, 'error');
                });
            };
            reader.readAsDataURL(blob);
        }
        
        // 预览多张图片
        function previewImages(files) {
            const previewContainer = document.getElementById('imagePreviewContainer');
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!currentImages.includes(e.target.result)) {
                        currentImages.push(e.target.result);
                        
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" onclick="openImageModal('${e.target.result}')">
                            <button class="btn btn-danger" style="position: absolute; top: 5px; right: 5px; padding: 2px 5px;" onclick="removeImage(${currentImages.length - 1})">×</button>
                        `;
                        previewContainer.appendChild(previewItem);
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 预览多张编辑图片
        function previewEditImages(files) {
            const previewContainer = document.getElementById('editImagePreviewContainer');
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!editImages.includes(e.target.result)) {
                        editImages.push(e.target.result);
                        
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" onclick="openImageModal('${e.target.result}')">
                            <button class="btn btn-danger" style="position: absolute; top: 5px; right: 5px; padding: 2px 5px;" onclick="removeEditImage(${editImages.length - 1})">×</button>
                        `;
                        previewContainer.appendChild(previewItem);
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 预览封面图片
        function previewCover(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('coverPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // 移除图片
        function removeImage(index) {
            currentImages.splice(index, 1);
            renderCurrentImages();
        }
        
        // 移除编辑图片
        function removeEditImage(index) {
            editImages.splice(index, 1);
            renderEditImages();
        }
        
        // 渲染当前图片
        function renderCurrentImages() {
            const previewContainer = document.getElementById('imagePreviewContainer');
            previewContainer.innerHTML = '';
            
            currentImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${image}" onclick="openImageModal('${image}')">
                    <button class="btn btn-danger" style="position: absolute; top: 5px; right: 5px; padding: 2px 5px;" onclick="removeImage(${index})">×</button>
                `;
                previewContainer.appendChild(previewItem);
            });
        }
        
        // 渲染编辑图片
        function renderEditImages() {
            const previewContainer = document.getElementById('editImagePreviewContainer');
            previewContainer.innerHTML = '';
            
            editImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${image}" onclick="openImageModal('${image}')">
                    <button class="btn btn-danger" style="position: absolute; top: 5px; right: 5px; padding: 2px 5px;" onclick="removeEditImage(${index})">×</button>
                `;
                previewContainer.appendChild(previewItem);
            });
        }
        
        // 打开图片模态框
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            modal.style.display = 'block';
            modalImg.src = imageSrc;
            
            // 添加ESC键监听
            document.addEventListener('keydown', handleEscKey);
        }
        
        // 关闭图片模态框
        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
            // 移除ESC键监听
            document.removeEventListener('keydown', handleEscKey);
        }
        
        // 打开编辑模态框
        function openEditModal(id) {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('editRecord')) {
                showToast('您没有权限编辑记录', 'error');
                return;
            }
            
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            document.getElementById('editId').value = record.id;
            document.getElementById('editMemberId').value = record.memberId;
            document.getElementById('editOperator').value = record.operator;
            document.getElementById('editShareDuration').value = record.shareDuration;
            document.getElementById('editAmount').value = record.amount.toFixed(2);
            document.getElementById('editNotes').value = record.notes || '';
            
            const previewContainer = document.getElementById('editImagePreviewContainer');
            previewContainer.innerHTML = '';
            editImages = [];
            
            if (record.image) {
                if (Array.isArray(record.image)) {
                    // 处理多张图片
                    record.image.forEach(img => {
                        editImages.push(img);
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                            <img src="${img}" onclick="openImageModal('${img}')">
                            <button class="btn btn-danger" style="position: absolute; top: 5px; right: 5px; padding: 2px 5px;" onclick="removeEditImage(${editImages.length - 1})">×</button>
                        `;
                        previewContainer.appendChild(previewItem);
                    });
                } else {
                    // 处理单张图片的旧记录
                    editImages.push(record.image);
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${record.image}" onclick="openImageModal('${record.image}')">
                        <button class="btn btn-danger" style="position: absolute; top: 5px; right: 5px; padding: 2px 5px;" onclick="removeEditImage(0)">×</button>
                    `;
                    previewContainer.appendChild(previewItem);
                }
            }
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // 关闭编辑模态框
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // 处理ESC键
        function handleEscKey(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        }
        
        // 下载图片
        function downloadImage(imageSrc) {
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = '分享图片_' + new Date().getTime() + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 保存记录到Firebase
        function saveRecord() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('createRecord')) {
                showToast('您没有权限创建记录', 'error');
                return;
            }
            
            const memberId = document.getElementById('memberId').value.trim();
            const operator = document.getElementById('operator').value;
            const operationTime = document.getElementById('operationTime').value;
            const shareDuration = parseInt(document.getElementById('shareDuration').value) || 0;
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const notes = document.getElementById('notes').value.trim();
            const images = currentImages;
            
            if (!memberId || !operator) {
                showToast('请填写会员ID和选择操作人', 'error');
                return;
            }
            
            // 直接保存Base64图片数据
            saveRecordToFirebase(memberId, operator, operationTime, shareDuration, amount, notes, images);
        }
        
        // 保存记录到Firebase数据库
        function saveRecordToFirebase(memberId, operator, operationTime, shareDuration, amount, notes, images) {
            const newRecordRef = database.ref('records').push();
            const record = {
                id: newRecordRef.key,
                memberId,
                operator,
                operationTime,
                shareDuration,
                amount,
                notes,
                image: images.length > 0 ? (images.length === 1 ? images[0] : images) : null,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: currentUser.uid,
                createdByName: currentUser.displayName || '未知用户'
            };
            
            newRecordRef.set(record)
                .then(() => {
                    showToast('记录已保存');
                    document.getElementById('recordForm').reset();
                    currentImages = [];
                    document.getElementById('imagePreviewContainer').innerHTML = '';
                    document.getElementById('amount').value = '0';
                    updateDateTime();
                })
                .catch(error => {
                    showToast('保存失败: ' + error.message, 'error');
                });
        }
        
        // 更新记录
        function updateRecord() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('editRecord')) {
                showToast('您没有权限编辑记录', 'error');
                return;
            }
            
            const id = document.getElementById('editId').value;
            const memberId = document.getElementById('editMemberId').value.trim();
            const operator = document.getElementById('editOperator').value;
            const shareDuration = parseInt(document.getElementById('editShareDuration').value) || 0;
            const amount = parseFloat(document.getElementById('editAmount').value) || 0;
            const notes = document.getElementById('editNotes').value.trim();
            const images = editImages;
            
            if (!memberId || !operator) {
                showToast('请填写会员ID和选择操作人', 'error');
                return;
            }
            
            updateRecordInFirebase(id, memberId, operator, shareDuration, amount, notes, images);
        }
        
        // 更新Firebase中的记录
        function updateRecordInFirebase(id, memberId, operator, shareDuration, amount, notes, images) {
            database.ref('records/' + id).update({
                memberId,
                operator,
                shareDuration,
                amount,
                notes,
                image: images.length > 0 ? (images.length === 1 ? images[0] : images) : null,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                updatedBy: currentUser.uid,
                updatedByName: currentUser.displayName || '未知用户'
            })
            .then(() => {
                showToast('记录已更新');
                closeEditModal();
            })
            .catch(error => {
                showToast('更新失败: ' + error.message, 'error');
            });
        }
        
        // 删除记录 (移动到回收站)
        function deleteRecord(id) {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('deleteRecord')) {
                showToast('您没有权限删除记录', 'error');
                return;
            }
            
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            if (!confirm('确定要删除这条记录吗？')) return;
            
            // 从记录中移除
            database.ref('records/' + id).remove()
                .then(() => {
                    // 添加到回收站
                    const deletedRecordRef = database.ref('deletedRecords').push();
                    const deletedRecord = {
                        ...record,
                        deletedAt: firebase.database.ServerValue.TIMESTAMP,
                        deletedBy: currentUser.uid,
                        deletedByName: currentUser.displayName || '未知用户',
                        originalId: id
                    };
                    
                    return deletedRecordRef.set(deletedRecord);
                })
                .then(() => {
                    showToast('记录已删除');
                })
                .catch(error => {
                    showToast('删除失败: ' + error.message, 'error');
                });
        }
        
        // 批量删除记录
        function batchDeleteRecords() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('deleteRecord')) {
                showToast('您没有权限删除记录', 'error');
                return;
            }
            
            if (selectedRecords.size === 0) {
                showToast('请先选择要删除的记录', 'error');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedRecords.size} 条记录吗？`)) return;
            
            const promises = Array.from(selectedRecords).map(id => {
                const record = records.find(r => r.id === id);
                if (!record) return Promise.resolve();
                
                // 从记录中移除
                return database.ref('records/' + id).remove()
                    .then(() => {
                        // 添加到回收站
                        const deletedRecordRef = database.ref('deletedRecords').push();
                        const deletedRecord = {
                            ...record,
                            deletedAt: firebase.database.ServerValue.TIMESTAMP,
                            deletedBy: currentUser.uid,
                            deletedByName: currentUser.displayName || '未知用户',
                            originalId: id
                        };
                        
                        return deletedRecordRef.set(deletedRecord);
                    });
            });
            
            Promise.all(promises)
                .then(() => {
                    showToast(`已删除 ${selectedRecords.size} 条记录`);
                    selectedRecords.clear();
                    document.getElementById('selectAll').checked = false;
                })
                .catch(error => {
                    showToast('批量删除失败: ' + error.message, 'error');
                });
        }
        
        // 恢复记录
        function restoreRecord(id) {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('restoreRecord')) {
                showToast('您没有权限恢复记录', 'error');
                return;
            }
            
            const record = deletedRecords.find(r => r.id === id);
            if (!record) return;
            
            if (!confirm('确定要恢复这条记录吗？')) return;
            
            // 从回收站中移除
            database.ref('deletedRecords/' + id).remove()
                .then(() => {
                    // 添加回记录
                    const { deletedAt, deletedBy, deletedByName, originalId, ...rest } = record;
                    const newRecordRef = database.ref('records').push();
                    
                    return newRecordRef.set({
                        ...rest,
                        id: newRecordRef.key,
                        restoredAt: firebase.database.ServerValue.TIMESTAMP,
                        restoredBy: currentUser.uid,
                        restoredByName: currentUser.displayName || '未知用户'
                    });
                })
                .then(() => {
                    showToast('记录已恢复');
                })
                .catch(error => {
                    showToast('恢复失败: ' + error.message, 'error');
                });
        }
        
        // 批量恢复记录
        function batchRestoreRecords() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('restoreRecord')) {
                showToast('您没有权限恢复记录', 'error');
                return;
            }
            
            if (selectedDeletedRecords.size === 0) {
                showToast('请先选择要恢复的记录', 'error');
                return;
            }
            
            if (!confirm(`确定要恢复选中的 ${selectedDeletedRecords.size} 条记录吗？`)) return;
            
            const promises = Array.from(selectedDeletedRecords).map(id => {
                const record = deletedRecords.find(r => r.id === id);
                if (!record) return Promise.resolve();
                
                // 从回收站中移除
                return database.ref('deletedRecords/' + id).remove()
                    .then(() => {
                        // 添加回记录
                        const { deletedAt, deletedBy, deletedByName, originalId, ...rest } = record;
                        const newRecordRef = database.ref('records').push();
                        
                        return newRecordRef.set({
                            ...rest,
                            id: newRecordRef.key,
                            restoredAt: firebase.database.ServerValue.TIMESTAMP,
                            restoredBy: currentUser.uid,
                            restoredByName: currentUser.displayName || '未知用户'
                        });
                    });
            });
            
            Promise.all(promises)
                .then(() => {
                    showToast(`已恢复 ${selectedDeletedRecords.size} 条记录`);
                    selectedDeletedRecords.clear();
                    document.getElementById('selectAllRecycle').checked = false;
                })
                .catch(error => {
                    showToast('批量恢复失败: ' + error.message, 'error');
                });
        }
        
        // 永久删除记录
        function permanentDeleteRecord(id) {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('deleteRecord')) {
                showToast('您没有权限删除记录', 'error');
                return;
            }
            
            if (!confirm('确定要永久删除这条记录吗？此操作不可撤销！')) return;
            
            database.ref('deletedRecords/' + id).remove()
                .then(() => {
                    showToast('记录已永久删除');
                })
                .catch(error => {
                    showToast('删除失败: ' + error.message, 'error');
                });
        }
        
        // 批量永久删除记录
        function batchPermanentDeleteRecords() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledRecordActions && permissions.disabledRecordActions.includes('deleteRecord')) {
                showToast('您没有权限删除记录', 'error');
                return;
            }
            
            if (selectedDeletedRecords.size === 0) {
                showToast('请先选择要删除的记录', 'error');
                return;
            }
            
            if (!confirm(`确定要永久删除选中的 ${selectedDeletedRecords.size} 条记录吗？此操作不可撤销！`)) return;
            
            const promises = Array.from(selectedDeletedRecords).map(id => {
                return database.ref('deletedRecords/' + id).remove();
            });
            
            Promise.all(promises)
                .then(() => {
                    showToast(`已永久删除 ${selectedDeletedRecords.size} 条记录`);
                    selectedDeletedRecords.clear();
                    document.getElementById('selectAllRecycle').checked = false;
                })
                .catch(error => {
                    showToast('批量删除失败: ' + error.message, 'error');
                });
        }
        
        // 加载最近10条记录
        function loadRecentRecords() {
            const recentRecordsBody = document.getElementById('recentRecordsBody');
            recentRecordsBody.innerHTML = '';
            
            const recentRecords = records.slice(0, 10);
            
            if (recentRecords.length === 0) {
                recentRecordsBody.innerHTML = '<tr><td colspan="7" class="empty-state"><i>暂无记录</i></td></tr>';
                return;
            }
            
            recentRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.memberId}</td>
                    <td>${record.operator}</td>
                    <td>${record.operationTime}</td>
                    <td>${record.shareDuration}小时</td>
                    <td>R$${record.amount.toFixed(2)}</td>
                    <td>
                        ${getImagePreview(record.image)}
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="openEditModal('${record.id}')">编辑</button>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">删除</button>
                    </td>
                `;
                recentRecordsBody.appendChild(row);
            });
        }
        
        // 获取图片预览HTML
        function getImagePreview(image) {
            if (!image) return '无';
            
            if (Array.isArray(image)) {
                if (image.length === 0) return '无';
                return `<img src="${image[0]}" class="image-preview" onclick="openImageModal('${image[0]}')">${image.length > 1 ? ` +${image.length - 1}` : ''}`;
            } else {
                return `<img src="${image}" class="image-preview" onclick="openImageModal('${image}')">`;
            }
        }
        
        // 加载所有记录 (带分页)
        function loadAllRecords(page = 1) {
            currentPage = page;
            const allRecordsBody = document.getElementById('allRecordsBody');
            allRecordsBody.innerHTML = '';
            
            const startIndex = (page - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const paginatedRecords = records.slice(startIndex, endIndex);
            
            if (paginatedRecords.length === 0) {
                allRecordsBody.innerHTML = '<tr><td colspan="9" class="empty-state"><i>暂无记录</i></td></tr>';
                renderPagination(0);
                return;
            }
            
            paginatedRecords.forEach(record => {
                const isSelected = selectedRecords.has(record.id);
                const row = document.createElement('tr');
                row.dataset.recordId = record.id;
                row.innerHTML = `
                    <td><input type="checkbox" class="batch-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRecordSelection('${record.id}', this)"></td>
                    <td>${record.memberId}</td>
                    <td>${record.operator}</td>
                    <td>${record.operationTime}</td>
                    <td>${record.shareDuration}小时</td>
                    <td>R$${record.amount.toFixed(2)}</td>
                    <td>${record.notes || '无'}</td>
                    <td>${getImagePreview(record.image)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="openEditModal('${record.id}')">编辑</button>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">删除</button>
                    </td>
                `;
                allRecordsBody.appendChild(row);
            });
            
            renderPagination(records.length);
        }
        
        // 加载回收站记录 (带分页)
        function loadRecycleBin(page = 1) {
            currentRecyclePage = page;
            const recycleBinBody = document.getElementById('recycleBinBody');
            recycleBinBody.innerHTML = '';
            
            const startIndex = (page - 1) * recyclePerPage;
            const endIndex = startIndex + recyclePerPage;
            const paginatedRecords = deletedRecords.slice(startIndex, endIndex);
            
            if (paginatedRecords.length === 0) {
                recycleBinBody.innerHTML = '<tr><td colspan="9" class="empty-state"><i>回收站为空</i></td></tr>';
                renderRecyclePagination(0);
                return;
            }
            
            paginatedRecords.forEach(record => {
                const deletedDate = new Date(record.deletedAt);
                const deletedTime = formatDateTime(deletedDate);
                const isSelected = selectedDeletedRecords.has(record.id);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="batch-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleDeletedRecordSelection('${record.id}', this)"></td>
                    <td>${record.memberId}</td>
                    <td>${record.operator}</td>
                    <td>${record.operationTime}</td>
                    <td>${deletedTime}</td>
                    <td>${record.shareDuration}小时</td>
                    <td>R$${record.amount.toFixed(2)}</td>
                    <td>${getImagePreview(record.image)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="restoreRecord('${record.id}')">恢复</button>
                        <button class="btn btn-danger" onclick="permanentDeleteRecord('${record.id}')">永久删除</button>
                    </td>
                `;
                recycleBinBody.appendChild(row);
            });
            
            renderRecyclePagination(deletedRecords.length);
        }
        
        // 渲染分页
        function renderPagination(totalRecords) {
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // 上一页按钮
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.innerHTML = '&laquo;';
                prevBtn.onclick = () => loadAllRecords(currentPage - 1);
                pagination.appendChild(prevBtn);
            }
            
            // 页码按钮
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'page-btn' + (i === currentPage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadAllRecords(i);
                pagination.appendChild(pageBtn);
            }
            
            // 下一页按钮
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.innerHTML = '&raquo;';
                nextBtn.onclick = () => loadAllRecords(currentPage + 1);
                pagination.appendChild(nextBtn);
            }
        }
        
        // 渲染回收站分页
        function renderRecyclePagination(totalRecords) {
            const totalPages = Math.ceil(totalRecords / recyclePerPage);
            const pagination = document.getElementById('recyclePagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // 上一页按钮
            if (currentRecyclePage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.innerHTML = '&laquo;';
                prevBtn.onclick = () => loadRecycleBin(currentRecyclePage - 1);
                pagination.appendChild(prevBtn);
            }
            
            // 页码按钮
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'page-btn' + (i === currentRecyclePage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadRecycleBin(i);
                pagination.appendChild(pageBtn);
            }
            
            // 下一页按钮
            if (currentRecyclePage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.innerHTML = '&raquo;';
                nextBtn.onclick = () => loadRecycleBin(currentRecyclePage + 1);
                pagination.appendChild(nextBtn);
            }
        }
        
        // 切换记录选择状态
        function toggleRecordSelection(id, checkbox) {
            if (checkbox.checked) {
                selectedRecords.add(id);
            } else {
                selectedRecords.delete(id);
                document.getElementById('selectAll').checked = false;
            }
        }
        
        // 切换已删除记录选择状态
        function toggleDeletedRecordSelection(id, checkbox) {
            if (checkbox.checked) {
                selectedDeletedRecords.add(id);
            } else {
                selectedDeletedRecords.delete(id);
                document.getElementById('selectAllRecycle').checked = false;
            }
        }
        
        // 全选/取消全选记录
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('#allRecordsBody .batch-checkbox');
            
            selectedRecords.clear();
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                if (selectAll) {
                    const id = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                    selectedRecords.add(id);
                }
            });
        }
        
        // 全选/取消全选已删除记录
        function toggleSelectAllRecycle() {
            const selectAll = document.getElementById('selectAllRecycle').checked;
            const checkboxes = document.querySelectorAll('#recycleBinBody .batch-checkbox');
            
            selectedDeletedRecords.clear();
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                if (selectAll) {
                    const id = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                    selectedDeletedRecords.add(id);
                }
            });
        }
        
        // 重置批量选择
        function resetBatchSelection() {
            selectedRecords.clear();
            selectedDeletedRecords.clear();
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAllRecycle').checked = false;
        }
        
        // 搜索记录
        function searchRecords() {
    // 1. 获取搜索框的值，并处理多余空格
    const searchTerm = document.getElementById('searchInput').value
        .toLowerCase()    // 转为小写，使搜索不区分大小写
        .trim()           // 去除首尾空格
        .replace(/\s+/g, ' ');  // 将多个连续空格替换为单个空格

    // 2. 如果搜索词为空，则加载所有记录
    if (!searchTerm) {
        loadAllRecords();
        return;
    }
    
    // 3. 过滤记录
    const filteredRecords = records.filter(record => {
        // 3.1 处理会员ID（去除所有空格）
        const memberId = record.memberId.toLowerCase().replace(/\s+/g, '');
        
        // 3.2 处理操作人（去除所有空格）
        const operator = record.operator.toLowerCase().replace(/\s+/g, '');
        
        // 3.3 处理备注（保留单词间单个空格）
        const notes = record.notes ? 
            record.notes.toLowerCase().replace(/\s+/g, ' ') : '';
        
        // 3.4 检查是否匹配
        return (
            // 会员ID匹配（完全去除空格）
            memberId.includes(searchTerm.replace(/\s+/g, '')) || 
            
            // 操作人匹配（完全去除空格）
            operator.includes(searchTerm.replace(/\s+/g, '')) ||
            
            // 备注匹配（保留单词间空格）
            notes.includes(searchTerm)
        );
    });
    
    // 4. 显示搜索结果
    displaySearchResults(filteredRecords);
}
        
        // 应用筛选
        function applyFilters() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const operator = document.getElementById('operatorFilter').value;
    const searchTerm = document.getElementById('searchInput').value
        .toLowerCase()
        .trim()
        .replace(/\s+/g, ' ');
    
    let filteredRecords = [...records];
    
    // 日期筛选（原逻辑不变）
    if (dateFrom) {
        const fromDate = new Date(dateFrom);
        filteredRecords = filteredRecords.filter(record => {
            const recordDate = new Date(record.operationTime);
            return recordDate >= fromDate;
        });
    }
    
    if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setDate(toDate.getDate() + 1);
        filteredRecords = filteredRecords.filter(record => {
            const recordDate = new Date(record.operationTime);
            return recordDate < toDate;
        });
    }
    
    // 操作人筛选（原逻辑不变）
    if (operator) {
        filteredRecords = filteredRecords.filter(record => record.operator === operator);
    }
    
    // 新增：搜索词筛选（优化后的逻辑）
    if (searchTerm) {
        filteredRecords = filteredRecords.filter(record => {
            const memberId = record.memberId.toLowerCase().replace(/\s+/g, '');
            const operator = record.operator.toLowerCase().replace(/\s+/g, '');
            const notes = record.notes ? record.notes.toLowerCase().replace(/\s+/g, ' ') : '';
            
            return (
                memberId.includes(searchTerm.replace(/\s+/g, '')) || 
                operator.includes(searchTerm.replace(/\s+/g, '')) ||
                notes.includes(searchTerm)
            );
        });
    }
    
    displaySearchResults(filteredRecords);
}
        
        // 显示搜索结果
        function displaySearchResults(filteredRecords) {
            const allRecordsBody = document.getElementById('allRecordsBody');
            allRecordsBody.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                allRecordsBody.innerHTML = '<tr><td colspan="9" class="empty-state"><i>未找到匹配记录</i></td></tr>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                row.dataset.recordId = record.id;
                row.innerHTML = `
                    <td><input type="checkbox" class="batch-checkbox" onchange="toggleRecordSelection('${record.id}', this)"></td>
                    <td>${record.memberId}</td>
                    <td>${record.operator}</td>
                    <td>${record.operationTime}</td>
                    <td>${record.shareDuration}小时</td>
                    <td>R$${record.amount.toFixed(2)}</td>
                    <td>${record.notes || '无'}</td>
                    <td>${getImagePreview(record.image)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="openEditModal('${record.id}')">编辑</button>
                        <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">删除</button>
                    </td>
                `;
                allRecordsBody.appendChild(row);
            });
            
            document.getElementById('pagination').innerHTML = '';
        }
        
        // 重置搜索
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('operatorFilter').value = '';
            loadAllRecords();
        }
        
        // 更新统计数据
        function updateStatistics() {
            // 总记录数
            document.getElementById('totalRecords').textContent = records.length;
            
            // 总派送金额
            const totalAmount = records.reduce((sum, record) => sum + (parseFloat(record.amount) || 0), 0);
            document.getElementById('totalAmount').textContent = `R$${totalAmount.toFixed(2)}`;
            
            // 总分享时长
            const totalDuration = records.reduce((sum, record) => sum + (parseInt(record.shareDuration) || 0), 0);
            document.getElementById('totalDuration').textContent = `${totalDuration}小时`;
            
            // 今日新增记录
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayRecords = records.filter(record => {
                const recordDate = new Date(record.operationTime);
                return recordDate >= today;
            });
            document.getElementById('todayRecords').textContent = todayRecords.length;
        }
        
        // 更新图表
        function updateCharts() {
            // 按日期分组的记录数量
            const dateCounts = {};
            records.forEach(record => {
                const date = record.operationTime.split(' ')[0]; // 只取日期部分
                dateCounts[date] = (dateCounts[date] || 0) + 1;
            });
            
            const dates = Object.keys(dateCounts).sort();
            const counts = dates.map(date => dateCounts[date]);
            
            // 销毁旧图表
            if (recordsChart) {
                recordsChart.destroy();
            }
            
            // 创建每日记录数量图表
            const recordsCtx = document.getElementById('recordsChart').getContext('2d');
            recordsChart = new Chart(recordsCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '每日记录数量',
                        data: counts,
                        backgroundColor: 'rgba(66, 133, 244, 0.2)',
                        borderColor: 'rgba(66, 133, 244, 1)',
                        borderWidth: 1,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            });
            
            // 按操作人分组的记录数量
            const operatorCounts = {};
            records.forEach(record => {
                operatorCounts[record.operator] = (operatorCounts[record.operator] || 0) + 1;
            });
            
            const operators = Object.keys(operatorCounts);
            const operatorData = operators.map(op => operatorCounts[op]);
            
            // 销毁旧图表
            if (operatorChart) {
                operatorChart.destroy();
            }
            
            // 创建操作人记录分布图表
            const operatorCtx = document.getElementById('operatorChart').getContext('2d');
            operatorChart = new Chart(operatorCtx, {
                type: 'bar',
                data: {
                    labels: operators,
                    datasets: [{
                        label: '记录数量',
                        data: operatorData,
                        backgroundColor: [
                            'rgba(66, 133, 244, 0.7)',
                            'rgba(234, 67, 53, 0.7)',
                            'rgba(251, 188, 5, 0.7)',
                            'rgba(52, 168, 83, 0.7)',
                            'rgba(168, 50, 168, 0.7)',
                            'rgba(66, 165, 245, 0.7)',
                            'rgba(244, 67, 54, 0.7)',
                            'rgba(253, 216, 53, 0.7)',
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(156, 39, 176, 0.7)',
                            'rgba(25, 118, 210, 0.7)'
                        ],
                        borderColor: [
                            'rgba(66, 133, 244, 1)',
                            'rgba(234, 67, 53, 1)',
                            'rgba(251, 188, 5, 1)',
                            'rgba(52, 168, 83, 1)',
                            'rgba(168, 50, 168, 1)',
                            'rgba(66, 165, 245, 1)',
                            'rgba(244, 67, 54, 1)',
                            'rgba(253, 216, 53, 1)',
                            'rgba(76, 175, 80, 1)',
                            'rgba(156, 39, 176, 1)',
                            'rgba(25, 118, 210, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            });
        }
        
        // 导出数据为CSV
        function exportToCSV() {
            let csv = '会员ID,操作人,操作时间,分享时长(小时),派送金额(R$),备注\n';
            
            records.forEach(record => {
                csv += `"${record.memberId}","${record.operator}","${record.operationTime}",${record.shareDuration},${record.amount},"${record.notes || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `记录导出_${new Date().toLocaleDateString()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('数据已导出为CSV文件');
        }
        
        // 切换主题选项显示
        function toggleThemeOptions() {
            document.getElementById('themeOptions').classList.toggle('show');
            document.getElementById('coverSettings').classList.remove('show');
        }
        
        // 切换封面设置显示
        function toggleCoverSettings() {
            document.getElementById('coverSettings').classList.toggle('show');
            document.getElementById('themeOptions').classList.remove('show');
        }
        
        // 切换表情选择器显示
        function toggleEmojiPicker() {
            document.getElementById('emojiPicker').classList.toggle('show');
        }
        
        // 更改主题
        function changeTheme(theme) {
            let root = document.documentElement;
            
            switch(theme) {
                case 'dark':
                    root.style.setProperty('--primary-color', '#4285f4');
                    root.style.setProperty('--secondary-color', '#34a853');
                    root.style.setProperty('--danger-color', '#ea4335');
                    root.style.setProperty('--warning-color', '#fbbc05');
                    root.style.setProperty('--bg-color', '#1e1e1e');
                    root.style.setProperty('--text-color', '#ffffff');
                    root.style.setProperty('--card-bg', '#2d2d2d');
                    root.style.setProperty('--border-color', '#444');
                    break;
                case 'light':
                    root.style.setProperty('--primary-color', '#4285f4');
                    root.style.setProperty('--secondary-color', '#34a853');
                    root.style.setProperty('--danger-color', '#ea4335');
                    root.style.setProperty('--warning-color', '#fbbc05');
                    root.style.setProperty('--bg-color', '#f5f5f5');
                    root.style.setProperty('--text-color', '#333333');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--border-color', '#dddddd');
                    break;
                case 'green':
                    root.style.setProperty('--primary-color', '#34a853');
                    root.style.setProperty('--secondary-color', '#4285f4');
                    root.style.setProperty('--danger-color', '#ea4335');
                    root.style.setProperty('--warning-color', '#fbbc05');
                    root.style.setProperty('--bg-color', '#f5f5f5');
                    root.style.setProperty('--text-color', '#333333');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--border-color', '#dddddd');
                    break;
                case 'blue':
                    root.style.setProperty('--primary-color', '#1a73e8');
                    root.style.setProperty('--secondary-color', '#34a853');
                    root.style.setProperty('--danger-color', '#ea4335');
                    root.style.setProperty('--warning-color', '#fbbc05');
                    root.style.setProperty('--bg-color', '#f5f5f5');
                    root.style.setProperty('--text-color', '#333333');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--border-color', '#dddddd');
                    break;
                default: // 默认主题
                    root.style.setProperty('--primary-color', '#4285f4');
                    root.style.setProperty('--secondary-color', '#34a853');
                    root.style.setProperty('--danger-color', '#ea4335');
                    root.style.setProperty('--warning-color', '#fbbc05');
                    root.style.setProperty('--bg-color', '#f5f5f5');
                    root.style.setProperty('--text-color', '#333333');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--border-color', '#dddddd');
            }
            
            // 保存主题到Firebase
            if (currentUser) {
                database.ref('userSettings/' + currentUser.uid + '/theme').set(theme)
                    .then(() => {
                        showToast('主题已更改');
                    })
                    .catch(error => {
                        console.error('保存主题失败:', error);
                    });
            }
            
            document.getElementById('themeOptions').classList.remove('show');
        }
        
        // 加载用户主题
        function loadTheme() {
            if (!currentUser) return;
            
            database.ref('userSettings/' + currentUser.uid + '/theme').once('value')
                .then(snapshot => {
                    const theme = snapshot.val();
                    if (theme) {
                        changeTheme(theme);
                    }
                })
                .catch(error => {
                    console.error('加载主题失败:', error);
                });
        }
        
        // 上传封面图片
        function uploadCover() {
            const fileInput = document.getElementById('coverUpload');
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('请先选择封面图片', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            showToast('正在上传封面...');
            
            reader.onload = function(e) {
                // 保存封面Base64数据到Firebase
                database.ref('userSettings/' + currentUser.uid + '/cover').set(e.target.result)
                    .then(() => {
                        showToast('封面已上传');
                        loadCover();
                        document.getElementById('coverSettings').classList.remove('show');
                    })
                    .catch(error => {
                        showToast('上传封面失败: ' + error.message, 'error');
                    });
            };
            
            reader.readAsDataURL(file);
        }
        
        // 移除封面
        function removeCover() {
            if (!confirm('确定要移除封面吗？')) return;
            
            database.ref('userSettings/' + currentUser.uid + '/cover').remove()
                .then(() => {
                    showToast('封面已移除');
                    document.getElementById('coverBackground').style.backgroundImage = 'none';
                    document.getElementById('coverPreview').src = '';
                    document.getElementById('coverSettings').classList.remove('show');
                })
                .catch(error => {
                    showToast('移除封面失败: ' + error.message, 'error');
                });
        }
        
        // 加载用户封面
        function loadCover() {
            if (!currentUser) return;
            
            database.ref('userSettings/' + currentUser.uid + '/cover').once('value')
                .then(snapshot => {
                    const coverData = snapshot.val();
                    if (coverData) {
                        document.getElementById('coverBackground').style.backgroundImage = `url(${coverData})`;
                        document.getElementById('coverPreview').src = coverData;
                    }
                })
                .catch(error => {
                    console.error('加载封面失败:', error);
                });
        }
        
        // 发送消息
        function sendMessage() {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledChatActions && permissions.disabledChatActions.includes('sendMessage')) {
                showToast('您没有权限发送消息', 'error');
                return;
            }
            
            const messageInput = document.getElementById('chatInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                showToast('消息不能为空', 'error');
                return;
            }
            
            const newMessageRef = database.ref('messages').push();
            newMessageRef.set({
                id: newMessageRef.key,
                text: message,
                sender: currentUser.uid,
                senderName: currentUser.displayName || '未知用户',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                deleted: false
            })
            .then(() => {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // 滚动到底部
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            })
            .catch(error => {
                showToast('发送消息失败: ' + error.message, 'error');
            });
        }
        
        // 渲染消息
        function renderMessage(message) {
            if (message.deleted) {
                return;
            }
            
            // 更新最后查看的消息时间
            if (message.timestamp > lastSeenMessageTime) {
                lastSeenMessageTime = message.timestamp;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender === currentUser.uid ? 'sent' : 'received'} ${message.image ? 'image-message' : ''}`;
            
            const isCurrentUser = message.sender === currentUser.uid;
            const canDeleteMessage = isCurrentUser || adminEmails.includes(currentUser.email);
            
            messageElement.innerHTML = `
                <div class="message-sender">${message.senderName}</div>
                <div class="message-content">
                    ${message.image ? 
                        `<img src="${message.image}" class="message-image" onclick="openImageModal('${message.image}')">` : 
                        `<div class="message-text">${message.text}</div>`
                    }
                    ${canDeleteMessage ? `
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="deleteMessage('${message.id}')" title="删除">×</button>
                        </div>
                    ` : ''}
                </div>
                <div class="message-time">${formatMessageTime(message.timestamp)}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            
            // 如果不是当前用户发送的消息且聊天标签页不是活动状态，增加未读计数
            if (!isCurrentUser && !isChatTabActive) {
                incrementUnreadCount();
            }
        }
        
        // 增加未读消息计数
        function incrementUnreadCount() {
            unreadMessages++;
            const badge = document.getElementById('unreadBadge');
            badge.textContent = unreadMessages;
            badge.style.display = 'flex';
            
            // 显示桌面通知
            if (Notification.permission === 'granted') {
                new Notification('新消息', {
                    body: `您有${unreadMessages}条未读消息`,
                    icon: 'https://cdn.jsdelivr.net/npm/emoji-datasource-apple/img/apple/64/1f4ac.png'
                });
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }
        
        // 重置未读计数
        function resetUnreadCount() {
            unreadMessages = 0;
            document.getElementById('unreadBadge').style.display = 'none';
        }
        
        // 格式化消息时间
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            
            // 如果是今天，只显示时间
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }
            
            // 如果是昨天
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return '昨天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }
            
            // 其他情况显示完整日期和时间
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 删除消息
        function deleteMessage(id) {
            if (!currentUser) {
                showToast('请先登录', 'error');
                return;
            }
            
            // 检查权限
            const permissions = userPermissions[currentUser.uid] || {};
            if (permissions.disabledChatActions && permissions.disabledChatActions.includes('deleteMessage')) {
                showToast('您没有权限删除消息', 'error');
                return;
            }
            
            if (!confirm('确定要删除这条消息吗？')) return;
            
            database.ref('messages/' + id).update({
                deleted: true,
                deletedAt: firebase.database.ServerValue.TIMESTAMP,
                deletedBy: currentUser.uid
            })
            .then(() => {
                showToast('消息已删除');
            })
            .catch(error => {
                showToast('删除消息失败: ' + error.message, 'error');
            });
        }
        
        // 清空所有聊天消息
        function clearAllMessages() {
            if (!adminEmails.includes(currentUser.email)) {
                showToast('只有管理员可以清空聊天记录', 'error');
                return;
            }
            
            if (!confirm('确定要清空所有聊天记录吗？此操作不可撤销！')) return;
            
            database.ref('messages').remove()
                .then(() => {
                    showToast('所有聊天记录已清空');
                })
                .catch(error => {
                    showToast('清空聊天记录失败: ' + error.message, 'error');
                });
        }
    </script>
</body>
</html>